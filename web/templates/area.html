<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ area.name }} - Home Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <a href="/" class="back-link">‚Üê Back to Dashboard</a>
        <h1>{{ area.name }}</h1>
        <p class="subtitle">{{ area.station }} Station</p>
    </header>

    <main>
        <!-- Score Card -->
        <section class="score-card">
            <div class="big-score">
                <span class="score-value">{{ area.score or '?' }}</span>
                <span class="score-max">/100</span>
            </div>
            <div class="score-breakdown">
                <div class="score-item">
                    <span class="label">Commute</span>
                    <span class="value">{{ area.commute_minutes }} min</span>
                </div>
                <div class="score-item">
                    <span class="label">Status</span>
                    <span class="value status-{{ area.status }}">{{ area.status | capitalize }}</span>
                </div>
                {% if area.explored_at %}
                <div class="score-item">
                    <span class="label">Explored</span>
                    <span class="value">{{ area.explored_at }}</span>
                </div>
                {% endif %}
            </div>
        </section>

        <!-- Area Map -->
        {% if area.lat and area.lng %}
        <section class="detail-card map-card">
            <div class="section-header">
                <h2>üìç Area Map</h2>
                <div class="map-legend">
                    <div class="legend-item"><span class="legend-marker legend-station"></span> Station</div>
                    <div class="legend-item"><span class="legend-marker legend-park"></span> Park/Garden</div>
                    <div class="legend-item"><span class="legend-marker legend-shop"></span> Supermarket</div>
                </div>
            </div>
            <div id="area-map" class="area-detail-map"></div>
        </section>
        {% endif %}

        <!-- Commute Details -->
        <section class="detail-card">
            <h2>üöÇ Commute</h2>
            <div class="detail-content">
                <div class="commute-info-grid">
                    <div class="commute-info-item">
                        <span class="commute-label">Station</span>
                        <span class="commute-value">{{ area.station }}</span>
                    </div>
                    <div class="commute-info-item">
                        <span class="commute-label">To King's Cross</span>
                        <span class="commute-value commute-highlight">{{ area.commute_minutes }} min</span>
                    </div>
                    {% if area.train_minutes %}
                    <div class="commute-info-item">
                        <span class="commute-label">Train Time</span>
                        <span class="commute-value">{{ area.train_minutes }} min</span>
                    </div>
                    {% endif %}
                    <div class="commute-info-item commute-route-item">
                        <span class="commute-label">Route</span>
                        <span class="commute-value {% if area.mainline_changes == 0 %}route-direct{% else %}route-change{% endif %}">
                            {{ area.route_summary or 'Direct service available' }}
                        </span>
                    </div>
                    {% if area.mainline_changes and area.mainline_changes > 0 %}
                    <div class="commute-info-item commute-changes-item">
                        <span class="commute-label">Mainline Changes</span>
                        <span class="commute-value route-change">{{ area.mainline_changes }} change{% if area.mainline_changes > 1 %}s{% endif %}</span>
                    </div>
                    {% endif %}
                    {% if cache.commute and cache.commute.trains_per_hour %}
                    <div class="commute-info-item">
                        <span class="commute-label">Trains/Hour</span>
                        <span class="commute-value">{{ cache.commute.trains_per_hour }}</span>
                    </div>
                    {% endif %}
                    {% if cache.commute and cache.commute.first_train %}
                    <div class="commute-info-item">
                        <span class="commute-label">First Train</span>
                        <span class="commute-value">{{ cache.commute.first_train }}</span>
                    </div>
                    {% endif %}
                    {% if cache.commute and cache.commute.last_train %}
                    <div class="commute-info-item">
                        <span class="commute-label">Last Train</span>
                        <span class="commute-value">{{ cache.commute.last_train }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </section>

        <!-- Nature Score Breakdown -->
        <section class="detail-card">
            <h2>üå≥ Nature & Green Spaces</h2>
            {% if nature %}
            <div class="detail-content">
                <!-- Nature Score Breakdown -->
                <div class="score-breakdown-grid">
                    <div class="score-breakdown-item">
                        <span class="breakdown-value">{{ nature.parks | length if nature.parks else 0 }}</span>
                        <span class="breakdown-label">Parks & Gardens</span>
                    </div>
                    <div class="score-breakdown-item">
                        <span class="breakdown-value">{{ nature.nature_reserves | length if nature.nature_reserves else 0 }}</span>
                        <span class="breakdown-label">Nature Reserves</span>
                    </div>
                    <div class="score-breakdown-item {% if nature.countryside_access %}breakdown-highlight{% endif %}">
                        <span class="breakdown-value">{% if nature.countryside_access %}‚úì{% else %}‚úó{% endif %}</span>
                        <span class="breakdown-label">Countryside Access</span>
                    </div>
                </div>

                {% if nature.parks %}
                <h4 class="amenity-section-title">üèûÔ∏è Parks & Gardens</h4>
                <div class="amenity-cards">
                    {% for park in nature.parks[:8] %}
                    <div class="amenity-card park-card">
                        <span class="amenity-name">{{ park.name }}</span>
                        <span class="amenity-distance">{{ park.distance_m }}m away</span>
                        {% if park.type %}
                        <span class="amenity-type">{{ park.type | capitalize }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if nature.parks | length > 8 %}
                    <div class="amenity-more">+{{ nature.parks | length - 8 }} more parks</div>
                    {% endif %}
                </div>
                {% endif %}

                {% if nature.nature_reserves %}
                <h4 class="amenity-section-title">üå≤ Nature Reserves & Woods</h4>
                <div class="amenity-cards">
                    {% for reserve in nature.nature_reserves[:4] %}
                    <div class="amenity-card reserve-card">
                        <span class="amenity-name">{{ reserve.name }}</span>
                        <span class="amenity-distance">{{ reserve.distance_m }}m away</span>
                        {% if reserve.type %}
                        <span class="amenity-type">{{ reserve.type | replace('_', ' ') | capitalize }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                {% if nature.countryside_access %}
                <p class="highlight">‚úì Good countryside access nearby - great for walks and nature!</p>
                {% endif %}
            </div>
            {% else %}
            <p class="empty-state">Nature data not yet collected. This area will be explored soon!</p>
            {% endif %}
        </section>

        <!-- Crime & Safety -->
        <section class="detail-card">
            <h2>üöî Safety & Crime</h2>
            {% if crime and crime.api_success %}
            <div class="detail-content">
                <!-- Crime Overview -->
                <div class="score-breakdown-grid">
                    <div class="score-breakdown-item">
                        <span class="breakdown-value">{{ crime.total_crimes }}</span>
                        <span class="breakdown-label">Total Crimes</span>
                    </div>
                    <div class="score-breakdown-item {% if crime.serious_crimes <= 10 %}breakdown-highlight{% endif %}">
                        <span class="breakdown-value">{{ crime.serious_crimes }}</span>
                        <span class="breakdown-label">Serious Crimes</span>
                    </div>
                    <div class="score-breakdown-item">
                        <span class="breakdown-value">{{ crime.property_crimes }}</span>
                        <span class="breakdown-label">Property Crimes</span>
                    </div>
                    <div class="score-breakdown-item">
                        <span class="breakdown-value">{{ crime.antisocial_behaviour }}</span>
                        <span class="breakdown-label">Anti-Social</span>
                    </div>
                </div>

                <!-- Safety Rating -->
                <div class="safety-rating" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    {% set weighted_crimes = crime.total_crimes + crime.serious_crimes %}
                    {% if weighted_crimes <= 50 %}
                    <p class="highlight" style="color: #059669; margin: 0;"><strong>‚úì Excellent safety</strong> - Very low crime area</p>
                    {% elif weighted_crimes <= 100 %}
                    <p class="highlight" style="color: #16a34a; margin: 0;"><strong>‚úì Good safety</strong> - Below average crime</p>
                    {% elif weighted_crimes <= 200 %}
                    <p style="color: #d97706; margin: 0;"><strong>‚ö†Ô∏è Moderate</strong> - Average crime levels</p>
                    {% else %}
                    <p style="color: #dc2626; margin: 0;"><strong>‚ö†Ô∏è Higher crime</strong> - Above average crime levels</p>
                    {% endif %}
                </div>

                <!-- Crime Breakdown -->
                {% if crime.crimes_by_category %}
                <h4 class="amenity-section-title" style="margin-top: 20px;">üìä Crime Breakdown ({{ crime.month }})</h4>
                <div class="crime-categories" style="display: grid; gap: 8px;">
                    {% for category, count in crime.crimes_by_category.items() | sort(attribute='1', reverse=True) %}
                    {% if count > 0 %}
                    <div class="crime-category-item" style="display: flex; justify-content: space-between; padding: 8px 12px; background: #f9fafb; border-radius: 4px;">
                        <span style="color: #4b5563;">{{ category | replace('-', ' ') | title }}</span>
                        <span style="font-weight: 600; color: {% if count > 20 %}#dc2626{% elif count > 10 %}#d97706{% else %}#059669{% endif %};">{{ count }}</span>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% endif %}

                <p style="margin-top: 15px; font-size: 0.85em; color: #6b7280;">
                    Data from UK Police API for {{ crime.month }}. Covers ~1 mile radius around station.
                </p>
            </div>
            {% else %}
            <p class="empty-state">Crime data not yet collected. This area will be explored soon!</p>
            {% endif %}
        </section>

        <!-- Amenities -->
        <section class="detail-card">
            <h2>üõí Amenities</h2>
            {% if amenities %}
            <div class="detail-content">
                <!-- Supermarkets -->
                {% if amenities.supermarkets %}
                <h4 class="amenity-section-title">üõçÔ∏è Supermarkets & Shops ({{ amenities.supermarkets | length }})</h4>
                <div class="amenity-cards">
                    {% for shop in amenities.supermarkets[:10] %}
                    <div class="amenity-card shop-card">
                        <span class="amenity-name">{{ shop.name }}</span>
                        <span class="amenity-distance">{{ shop.distance_m }}m away</span>
                        {% if shop.type %}
                        <span class="amenity-type">{{ shop.type | capitalize }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% if amenities.supermarkets | length > 10 %}
                    <div class="amenity-more">+{{ amenities.supermarkets | length - 10 }} more shops</div>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Pharmacies -->
                {% if amenities.pharmacies %}
                <h4 class="amenity-section-title">üíä Pharmacies ({{ amenities.pharmacies | length }})</h4>
                <div class="amenity-cards">
                    {% for pharm in amenities.pharmacies[:6] %}
                    <div class="amenity-card pharmacy-card">
                        <span class="amenity-name">{{ pharm.name }}</span>
                        <span class="amenity-distance">{{ pharm.distance_m }}m away</span>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% else %}
            <p class="empty-state">Amenity data not yet collected. This area will be explored soon!</p>
            {% endif %}
        </section>

        <!-- Sample Listings -->
        <section class="detail-card">
            <h2>üè† Sample Listings</h2>
            {% if sample_listings %}
            <div class="listings-grid">
                {% for listing in sample_listings[:5] %}
                <div class="listing-card">
                    <div class="listing-price">¬£{{ listing.price }} pcm</div>
                    <div class="listing-details">
                        {{ listing.bedrooms }} bed | {{ listing.type }}
                    </div>
                    <a href="{{ listing.url }}" target="_blank" class="listing-link">View ‚Üí</a>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="listings-placeholder">
                <p class="empty-state">Sample listings coming soon!</p>
                <p class="listing-note">Once this area is fully explored, we'll show sample rental listings to give you an idea of prices in the area.</p>
                <div class="external-links">
                    <a href="https://www.rightmove.co.uk/property-to-rent/search.html?searchLocation={{ area.name | urlencode }}" target="_blank" class="external-link">
                        üîç Search on Rightmove
                    </a>
                    <a href="https://www.zoopla.co.uk/to-rent/property/{{ area.name | lower | replace(' ', '-') }}/" target="_blank" class="external-link">
                        üîç Search on Zoopla
                    </a>
                </div>
            </div>
            {% endif %}
        </section>

        <!-- Notes -->
        {% if cache.notes %}
        <section class="detail-card">
            <h2>üìù Notes</h2>
            <div class="notes-content">
                {{ cache.notes }}
            </div>
        </section>
        {% endif %}
    </main>

    <footer>
        <a href="/">‚Üê Back to Dashboard</a>
    </footer>

    <!-- Leaflet JS for map -->
    {% if area.lat and area.lng %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialize map centered on area
        const areaLat = {{ area.lat }};
        const areaLng = {{ area.lng }};
        const areaName = "{{ area.name }}";
        const stationName = "{{ area.station }}";

        const map = L.map('area-map').setView([areaLat, areaLng], 14);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Station marker (red)
        const stationIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-inner station-marker">üöâ</div>',
            iconSize: [32, 32],
            iconAnchor: [16, 16]
        });
        L.marker([areaLat, areaLng], { icon: stationIcon })
            .addTo(map)
            .bindPopup('<strong>' + stationName + ' Station</strong><br>üìç Center of search area');

        // Parks/gardens (green markers)
        {% if nature and nature.parks %}
        const parkIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-inner park-marker">üå≥</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        {% for park in nature.parks[:12] %}
        {% if park.lat and park.lng %}
        L.marker([{{ park.lat }}, {{ park.lng }}], { icon: parkIcon })
            .addTo(map)
            .bindPopup('<strong>{{ park.name | e }}</strong><br>{{ park.distance_m }}m from station<br>{{ park.type | default("Park") | capitalize }}');
        {% endif %}
        {% endfor %}
        {% endif %}

        // Supermarkets (blue markers)
        {% if amenities and amenities.supermarkets %}
        const shopIcon = L.divIcon({
            className: 'custom-marker',
            html: '<div class="marker-inner shop-marker">üõí</div>',
            iconSize: [24, 24],
            iconAnchor: [12, 12]
        });
        {% for shop in amenities.supermarkets[:12] %}
        {% if shop.lat and shop.lng %}
        L.marker([{{ shop.lat }}, {{ shop.lng }}], { icon: shopIcon })
            .addTo(map)
            .bindPopup('<strong>{{ shop.name | e }}</strong><br>{{ shop.distance_m }}m from station<br>{{ shop.type | default("Supermarket") | capitalize }}');
        {% endif %}
        {% endfor %}
        {% endif %}

        // Add a 1km radius circle around station
        L.circle([areaLat, areaLng], {
            color: '#2563eb',
            fillColor: '#2563eb',
            fillOpacity: 0.05,
            radius: 1000,
            weight: 1,
            dashArray: '5, 5'
        }).addTo(map).bindPopup('1km radius from station');
    </script>
    {% endif %}
</body>
</html>
