<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Finder - Chin & Reg</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <header>
        <h1>ğŸ  Home Finder</h1>
        <p class="subtitle">Finding your next home near London</p>
    </header>

    <main>
        <!-- Stats Banner -->
        <section class="stats-banner">
            <div class="stat">
                <span class="stat-value">{{ stats.explored }}</span>
                <span class="stat-label">Explored</span>
            </div>
            <div class="stat">
                <span class="stat-value">{{ stats.pending }}</span>
                <span class="stat-label">Pending</span>
            </div>
            <div class="stat">
                <span class="stat-value">{{ stats.total }}</span>
                <span class="stat-label">Total Areas</span>
            </div>
            <div class="stat phase">
                <span class="stat-value">Phase {{ phase }}</span>
                <span class="stat-label">{% if phase == 1 %}Area Discovery{% else %}Property Hunting{% endif %}</span>
            </div>
        </section>

        <!-- Criteria Summary -->
        <section class="criteria-card">
            <h2>ğŸ“‹ Search Criteria</h2>
            <div class="criteria-grid">
                <div class="criteria-item">
                    <span class="label">ğŸš‚ Max Commute</span>
                    <span class="value">{{ criteria.commute.max_minutes }} min to King's Cross</span>
                </div>
                <div class="criteria-item">
                    <span class="label">ğŸ›ï¸ Bedrooms</span>
                    <span class="value">{{ criteria.property.min_bedrooms }}+</span>
                </div>
                <div class="criteria-item">
                    <span class="label">ğŸ’° Budget</span>
                    <span class="value">Â£{{ criteria.property.budget.guide }} - Â£{{ criteria.property.budget.max }} pcm</span>
                </div>
                <div class="criteria-item">
                    <span class="label">ğŸš— Parking</span>
                    <span class="value">{{ criteria.property.parking | capitalize }}</span>
                </div>
            </div>
        </section>

        <!-- Interactive Map Section -->
        <section class="map-section">
            <div class="section-header">
                <h2>ğŸ—ºï¸ Commutable Areas Map</h2>
                <div class="map-legend">
                    <span class="legend-item"><span class="legend-marker legend-explored"></span> Explored</span>
                    <span class="legend-item"><span class="legend-marker legend-pending"></span> Pending</span>
                    <span class="legend-item"><span class="legend-marker legend-destination"></span> King's Cross</span>
                </div>
            </div>
            <div id="areasMap" class="areas-map"></div>
        </section>

        <!-- All Areas Section with Filters -->
        <section class="areas-section areas-table-section">
            <div class="section-header">
                <h2>ğŸ“ All Commutable Areas</h2>
                <span class="area-count" id="areaCount">{{ stats.total }} areas</span>
            </div>
            
            <!-- Search and Filter Controls -->
            <div class="filter-controls">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search areas or stations..." autocomplete="off">
                    <span class="search-icon">ğŸ”</span>
                </div>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="explored">âœ… Explored</button>
                    <button class="filter-btn" data-filter="pending">â³ Pending</button>
                </div>
            </div>

            <!-- Areas Table -->
            <div class="areas-table-container">
                <table class="areas-table" id="areasTable">
                    <thead>
                        <tr>
                            <th class="sortable sorted-asc" data-sort="commute">
                                <span>Commute</span>
                                <span class="sort-indicator">â†‘</span>
                            </th>
                            <th class="sortable" data-sort="name">
                                <span>Area</span>
                                <span class="sort-indicator"></span>
                            </th>
                            <th class="sortable" data-sort="station">
                                <span>Station</span>
                                <span class="sort-indicator"></span>
                            </th>
                            <th class="sortable" data-sort="status">
                                <span>Status</span>
                                <span class="sort-indicator"></span>
                            </th>
                            <th class="sortable" data-sort="score">
                                <span>Score</span>
                                <span class="sort-indicator"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="areasTableBody">
                        {% for area in all_areas %}
                        <tr class="area-table-row {{ area.status }}" 
                            data-name="{{ area.name | lower }}" 
                            data-station="{{ area.station | lower }}"
                            data-status="{{ area.status }}"
                            data-commute="{{ area.commute_minutes }}"
                            data-score="{{ area.score or 0 }}"
                            onclick="window.location.href='/area/{{ area.name | urlencode }}'">
                            <td class="commute-cell">
                                <span class="commute-badge">{{ area.commute_minutes }} min</span>
                                {% if area.mainline_changes and area.mainline_changes > 0 %}
                                <span class="route-warning" title="{{ area.mainline_changes }} mainline change{% if area.mainline_changes > 1 %}s{% endif %} required">âš ï¸</span>
                                {% endif %}
                            </td>
                            <td class="name-cell">
                                <span class="area-name-link">{{ area.name }}</span>
                            </td>
                            <td class="station-cell">{{ area.station }}</td>
                            <td class="status-cell">
                                <span class="status-badge status-{{ area.status }}">
                                    {% if area.status == 'explored' %}âœ…{% else %}â³{% endif %}
                                    {{ area.status | capitalize }}
                                </span>
                            </td>
                            <td class="score-cell">
                                {% if area.score %}
                                <span class="score-badge">{{ area.score }}/100</span>
                                {% else %}
                                <span class="score-empty">â€”</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- No Results Message -->
            <div class="no-results" id="noResults" style="display: none;">
                <p>No areas match your search or filter criteria.</p>
            </div>
        </section>
    </main>

    <footer>
        <p>Last updated: {{ last_updated }} | Move target: June 2026</p>
    </footer>

    <script>
        // Areas table functionality
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            const filterButtons = document.querySelectorAll('.filter-btn');
            const tableBody = document.getElementById('areasTableBody');
            const areaCount = document.getElementById('areaCount');
            const noResults = document.getElementById('noResults');
            const table = document.getElementById('areasTable');
            
            let currentFilter = 'all';
            let currentSearch = '';
            let currentSort = 'commute';
            let sortAscending = true;

            // Filter buttons
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentFilter = this.dataset.filter;
                    applyFilters();
                });
            });

            // Search input
            searchInput.addEventListener('input', function() {
                currentSearch = this.value.toLowerCase().trim();
                applyFilters();
            });

            // Sortable headers
            table.querySelectorAll('th.sortable').forEach(th => {
                th.addEventListener('click', function() {
                    const sortKey = this.dataset.sort;
                    
                    // Toggle direction if same column
                    if (currentSort === sortKey) {
                        sortAscending = !sortAscending;
                    } else {
                        currentSort = sortKey;
                        sortAscending = true;
                    }
                    
                    // Update header styles
                    table.querySelectorAll('th.sortable').forEach(h => {
                        h.classList.remove('sorted-asc', 'sorted-desc');
                        h.querySelector('.sort-indicator').textContent = '';
                    });
                    this.classList.add(sortAscending ? 'sorted-asc' : 'sorted-desc');
                    this.querySelector('.sort-indicator').textContent = sortAscending ? 'â†‘' : 'â†“';
                    
                    sortTable();
                });
            });

            function applyFilters() {
                const rows = tableBody.querySelectorAll('tr');
                let visibleCount = 0;

                rows.forEach(row => {
                    const name = row.dataset.name;
                    const station = row.dataset.station;
                    const status = row.dataset.status;
                    
                    // Check filter
                    const passesFilter = currentFilter === 'all' || status === currentFilter;
                    
                    // Check search
                    const passesSearch = !currentSearch || 
                        name.includes(currentSearch) || 
                        station.includes(currentSearch);
                    
                    if (passesFilter && passesSearch) {
                        row.style.display = '';
                        visibleCount++;
                    } else {
                        row.style.display = 'none';
                    }
                });

                // Update count
                areaCount.textContent = `${visibleCount} area${visibleCount !== 1 ? 's' : ''}`;
                
                // Show/hide no results message
                noResults.style.display = visibleCount === 0 ? 'block' : 'none';
            }

            function sortTable() {
                const rows = Array.from(tableBody.querySelectorAll('tr'));
                
                rows.sort((a, b) => {
                    let aVal, bVal;
                    
                    switch (currentSort) {
                        case 'commute':
                            aVal = parseInt(a.dataset.commute);
                            bVal = parseInt(b.dataset.commute);
                            break;
                        case 'name':
                            aVal = a.dataset.name;
                            bVal = b.dataset.name;
                            break;
                        case 'station':
                            aVal = a.dataset.station;
                            bVal = b.dataset.station;
                            break;
                        case 'status':
                            aVal = a.dataset.status;
                            bVal = b.dataset.status;
                            break;
                        case 'score':
                            aVal = parseInt(a.dataset.score) || 0;
                            bVal = parseInt(b.dataset.score) || 0;
                            break;
                        default:
                            return 0;
                    }
                    
                    if (typeof aVal === 'string') {
                        return sortAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    } else {
                        return sortAscending ? aVal - bVal : bVal - aVal;
                    }
                });
                
                // Re-append rows in sorted order
                rows.forEach(row => tableBody.appendChild(row));
            }
        });
    </script>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Map Initialization -->
    <script>
        // Initialize map centered on London area
        const map = L.map('areasMap').setView([51.55, -0.1], 9);
        
        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);
        
        // King's Cross marker (special destination marker)
        const kingsCrossIcon = L.divIcon({
            className: 'custom-marker destination-marker',
            html: '<div class="marker-inner destination">ğŸ¯</div>',
            iconSize: [36, 36],
            iconAnchor: [18, 18],
            popupAnchor: [0, -18]
        });
        
        L.marker([51.5309, -0.1233], { icon: kingsCrossIcon })
            .addTo(map)
            .bindPopup('<strong>King\'s Cross</strong><br>Your destination');
        
        // Area data from server
        const areas = [
            {% for area in all_areas %}
            {
                name: "{{ area.name }}",
                station: "{{ area.station }}",
                lat: {{ area.lat or 'null' }},
                lng: {{ area.lng or 'null' }},
                commute: {{ area.commute_minutes }},
                status: "{{ area.status }}",
                score: {{ area.score or 'null' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];
        
        // Function to create marker icon based on status and score
        function createMarkerIcon(status, score) {
            const isExplored = status === 'explored';
            const size = isExplored && score ? Math.max(20, Math.min(32, 16 + score * 0.16)) : 20;
            
            return L.divIcon({
                className: `custom-marker ${isExplored ? 'explored-marker' : 'pending-marker'}`,
                html: `<div class="marker-inner ${isExplored ? 'explored' : 'pending'}" style="width:${size}px;height:${size}px;"></div>`,
                iconSize: [size, size],
                iconAnchor: [size/2, size/2],
                popupAnchor: [0, -size/2]
            });
        }
        
        // Add markers for each area
        areas.forEach(area => {
            if (area.lat && area.lng) {
                const marker = L.marker([area.lat, area.lng], {
                    icon: createMarkerIcon(area.status, area.score)
                }).addTo(map);
                
                // Create popup content
                let popupContent = `
                    <div class="map-popup">
                        <strong>${area.name}</strong><br>
                        ğŸš‰ ${area.station}<br>
                        ğŸ• ${area.commute} min commute
                `;
                
                if (area.status === 'explored' && area.score) {
                    popupContent += `<br>â­ Score: ${area.score}/100`;
                }
                
                popupContent += `<br><a href="/area/${encodeURIComponent(area.name)}" class="popup-link">View details â†’</a></div>`;
                
                marker.bindPopup(popupContent);
            }
        });
        
        // Fit map to show all markers
        if (areas.length > 0) {
            const validAreas = areas.filter(a => a.lat && a.lng);
            if (validAreas.length > 0) {
                const bounds = L.latLngBounds(validAreas.map(a => [a.lat, a.lng]));
                // Include King's Cross in bounds
                bounds.extend([51.5309, -0.1233]);
                map.fitBounds(bounds, { padding: [30, 30] });
            }
        }
    </script>
</body>
</html>
